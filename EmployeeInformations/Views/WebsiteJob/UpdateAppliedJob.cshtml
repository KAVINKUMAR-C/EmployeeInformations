@using EmployeeInformations.Model.APIModel;
@model WebsiteJobApplyModel
@{
    ViewBag.Title = "Update Website Applied Job";
}


<div class="nk-block-head nk-block-head-sm">
    <div class="nk-block-between">
        <div class="nk-block-head-content">
            <h3 class="nk-block-title page-title">Update Website Applied Job</h3>
        </div><!-- .nk-block-head-content -->
    </div><!-- .nk-block-between -->
</div>
<div class="card card-bordered card-preview">
    <div class="card-inner">
        <form autocomplete="off">
            @Html.AntiForgeryToken()
            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
            <div class="tab-content">
                <div class="tab-pane in active">
                    <div class="row">
                        <input type="hidden" id="strFmtSkill" value="@Model.SkillSet" />
                        @Html.HiddenFor(m => m.JobApplyId)
                        @Html.HiddenFor(m => m.JobId)
                        @Html.HiddenFor(m => m.IsActive)
                        @Html.HiddenFor(m => m.Attachment)
                        @Html.HiddenFor(m => m.ApplyDate)
                        @Html.HiddenFor(m => m.IsRecordForm)
                        <input type="hidden" id="existFilePath" value="@Model.FilePath" />
                        <div class="col-xxl-3 col-xl-4 col-lg-4 col-md-6">
                            <div class="form-group">
                                <label class="form-label">Name<span class="required" style="color: #FF0000">*</span></label>
                                @Html.TextBoxFor(m => m.FullName, new { @class = "form-control" })
                                @Html.ValidationMessageFor(m => m.FullName, "", new { @class = "error text-danger", id = "errValid-FullName" })
                            </div>
                        </div>

                        <div class="col-xxl-3 col-xl-4 col-lg-4 col-md-6 autocomplete">
                            <div class="form-group emp-hol-yr">
                                <label class="form-label">Role<span class="required" style="color: #FF0000">*</span></label>
                                @Html.DropDownListFor(m => m.JobId, new SelectList(Model.WebsiteJobViewModels, "JobId", "JobName"), new { @class = "form-control", id = "JobName" })
                                @Html.ValidationMessageFor(m => m.JobId, "", new { @class = "error text-danger", id = "errValid-JobName" })
                            </div>
                        </div>

                        <div class="col-xxl-3 col-xl-4 col-lg-4 col-md-6">
                            <div class="form-group">
                                <label class="form-label">Email<span class="required" style="color: #FF0000">*</span></label>
                                @Html.TextBoxFor(m => m.Email, new { @class = "form-control" })
                                @Html.ValidationMessageFor(m => m.Email, "", new { @class = "error text-danger", id = "errValid-Email" })
                                <span id="errVerifyEmailFormat-OfficeEmail" style="display:none;" class="error text-danger">Email is invalid </span>
                            </div>
                        </div>

                        <div class="col-xxl-3 col-xl-4 col-lg-4 col-md-6">
                            <div class="form-group">
                                <label class="form-label">Experience<span class="required" style="color: #FF0000">*</span></label>
                                @Html.TextBoxFor(m => m.Experience, new { @class = "form-control" })
                                @Html.ValidationMessageFor(m => m.Experience, "", new { @class = "error text-danger", id = "errValid-Experience" })
                            </div>
                        </div>

                        <div class="col-xxl-3 col-xl-4 col-lg-4 col-md-6">
                            <div class="form-group">
                                <label class="form-label">Relevant Experience<span class="required" style="color: #FF0000">*</span></label>
                                @Html.TextBoxFor(m => m.RelevantExperience, new { @class = "form-control" })
                                @Html.ValidationMessageFor(m => m.RelevantExperience, "", new { @class = "error text-danger", id = "errValid-RelevantExperience" })
                            </div>
                        </div>

                        @if (Model.IsRecordForm == "Manual")
                        {
                            <div class="col-xxl-3 col-xl-4 col-lg-4 col-md-6 autocomplete">
                                <div class="form-group emp-hol-yr">
                                    <label class="form-label">Skill Sets<span class="required" style="color: #FF0000">*</span></label>
                                    <div class="selectbox">
                                        @Html.DropDownListFor(m => m.SkillId, new SelectList(Model.Skills, "SkillId", "SkillName"), new { @class = "form-control", id = "skills", multiple = true })
                                    </div>
                                    @Html.ValidationMessageFor(m => m.SkillId, "", new { @class = "error text-danger", id = "errValid-Skills" })
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="col-xxl-3 col-xl-4 col-lg-4 col-md-6 autocomplete">
                                <div class="form-group emp-hol-yr">
                                    <label class="form-label">Skill Sets<span class="required" style="color: #FF0000">*</span></label>
                                    <div class="selectbox">
                                        @Html.DropDownListFor(m => m.SkillId, new SelectList(Model.Skills, "SkillId", "SkillName"), new { @class = "form-control", @disabled = true })
                                    </div>
                                </div>
                            </div>
                        }

                        @if (Model.IsRecordForm == "Manual")
                        {
                            <div class="col-xxl-3 col-xl-4 col-lg-4 col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Is Record Form</label>
                                    @Html.TextBoxFor(m => m.IsRecordForm, new { @class = "form-control", @disabled = true })
                                    @Html.ValidationMessageFor(m => m.IsRecordForm, "", new { @class = "error text-danger", id = "errValid-IsRecordForm" })
                                </div>
                            </div>
                        }


                        <div class="col-xxl-3 col-xl-4 col-lg-4 col-md-6">
                            <div class="form-group">
                                <label class="form-label">Document<span class="required" style="color: #FF0000">*</span></label>
                                <div class="input-group custom-file-button">
                                    @Html.TextBoxFor(m => m.FilePath, new { type = "file", name = "file", @class = "form-control" })
                                </div>
                                @if (Model.FilePath != null)
                                {
                                    @if (Model.splitdocname == "pdf")
                                    {
                                        <div class="mt-1 docWebsiteFile">
                                            <img src="/images/Pdf-Icon.png" style="height: 40px;">
                                            <span style="display:none;">@Model.FileName</span>
                                        </div>

                                    }
                                    else if (Model.splitdocname == "doc" || Model.splitdocname == "docx")
                                    {
                                        <div class="mt-1 docWebsiteFile">
                                            <img src="/images/Doc-Icon.png" style="height: 40px;">
                                            <span style="display:none;">@Model.FileName</span>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="mt-1 docWebsiteFile">
                                            <img src="/images/Image-Icon.png" style="height: 40px;">
                                            <span style="display:none;">@Model.FileName</span>
                                        </div>

                                    }
                                }
                                @Html.ValidationMessageFor(m => m.FilePath, "", new { @class = "error text-danger", id = "errValid-AttachmentFilePath" })
                                <span class="error text-danger" id="errValid-ErrorFileSize"></span>
                                <span id="errValid-Document" class="error text-danger" style="display:none;"> Invalid document </span>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="col-lg-12 d-flex mt-3">
                    <input type="button" class="btn btn-secondary ml-auto mr-3" id="btnBack" value="Back" />
                    <input type="button" class="btn btn-primary" id="btnUpdateWebsiteJob" value="Save" />
                </div>
            </div>
        </form>
    </div>
</div>
<div class="modal" id="success_CreateWebsiteJob_Popup" style="display:none;">
    <div class="modal-dialog">
        <div class="modal-content p-3 text-center">

            <!-- Modal body -->
            <div class="modal-body" id="txtSuccessMeg">
                <h4 class="nk-modal-title"> Website Applied Job Updated Successfully!</h4>
            </div>

            <!-- Modal footer -->
            <div class="text-center" id="btnCloseWebsiteJob">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>


<script type="text/javascript" src="~/scripts/ckeditor.js" asp-append-version="true"></script>

<script type="text/javascript">

    $(document).ready(function () {
        var report = $("#skills").select2();
        $("#skills").select2().on("change", function () {
            $("#errValid-Skills").text("")
        });
        //-----------------------------------------------------------------------------------------------------------------------------

        // SkillSet Nice scroll

        $("#skills,#JobName").select2().on("select2:open", function () {
            $('.select2-results__options').niceScroll({
                cursorcolor: "#4e5e7a",
                cursorwidth: "5px",
                autohidemode: false,
                cursorborder: "1px solid #4e5e7a",
                horizrailenabled: false,
            });
        });
        //-----------------------------------------------------------------------------------------------------------------------------

        var strFmtSkill = $("#strFmtSkill").val();
        if (strFmtSkill != "") {
            var lengthReportingPersonId = strFmtSkill.split(',').length;
            var splitReportingPersonId = strFmtSkill.split(',');
            for (var i = 0; i < lengthReportingPersonId; i++) {

                var valueSkills = $("#skills option:contains(" + splitReportingPersonId[i] + ")").val();

                $("#skills option[value=" + valueSkills + "]").attr('selected', 'selected').trigger("change");
            }
        }

        //----------------------------------------------------------------------------------------------------------------------------

        // Back button click

        $('#btnBack').click(function () {
            var urlToRedirect = '@Url.Action("WebsiteJobApply", "WebsiteJob")';
            window.location.href = urlToRedirect;
        });
        //----------------------------------------------------------------------------------------------------------------------------
        $(".docWebsiteFile").on('click', function () {
            var imgName = $(this).text().trim();
            var urlName = window.location.origin;
            window.open(urlName + '/Management/' + imgName + '');
        });
    });

    //Change Summary

    $("#skills").change(function () {
        $("#errValid-Skills").text("");
        if ($("#skills option:selected").text() == '') {
            $("#errValid-Skills").text("Skills field is required");
        }
        else {
            $("#errValid-Skills").text("");
        }
    });


    //KeyUp Summary

    $("#FullName").keyup(function () {
        $("#errValid-FullName").text("");
        if ($("#FullName").val() == "") {
            $("#errValid-FullName").text("Name field is required");
        }
    });

    $("#JobName").keyup(function () {
        $("#errValid-JobName").text("");
        if ($("#JobName").val() == "") {
            $("#errValid-JobName").text("Job Name field is required");
        }

    });

    $("#Email").keyup(function () {
        $("#errVerifyEmailFormat-OfficeEmail").hide();
        $("#errValid-Email").text("");
        if ($("#Email").val() == "") {
            $("#errValid-Email").text("Email field is required");
        }
    });

    $("#Experience").keyup(function () {
        $("#errValid-Experience").text("");
        if ($("#Experience").val() == "") {
            $("#errValid-Experience").text("Experience field is required");
        }
    });


    $("#RelevantExperience").keyup(function () {
        $("#errValid-RelevantExperience").text("");
        if ($("#RelevantExperience").val() == "") {
            $("#errValid-RelevantExperience").text("Relevant Experience field is required");
        }
    });
    //----------------------------------------------------------------------------------------------------------------------------------------

    // update Website Job

    $("#btnUpdateWebsiteJob").click(function () {
        var formData = new FormData();

        var isValid = true;
        $("#errValid-FullName").text("");
        $("#errValid-JobName").text("");
        $("#errValid-Email").text("");
        $("#errValid-Experience").text("");
        $("#errValid-RelevantExperience").text("");
        $("#errValid-ErrorFileSize").text('');
        $("#errValid-AttachmentFilePath").text("");
        $("#errVerifyEmailFormat-OfficeEmail").hide();

        if ($("#FullName").val() == "") {
            $("#errValid-FullName").text("Name field is required");
            isValid = false;
        }

        if ($("#JobName").val() == "") {
            $("#errValid-JobName").text("Job Name field is required");
            isValid = false;
        }

        if ($("#Email").val() == "") {
            $("#errValid-Email").text("Email field is required");
            isValid = false;
        }

        if ($("#Experience").val() == "") {
            $("#errValid-Experience").text("Experience field is required");
            isValid = false;
        }

        if ($("#RelevantExperience").val() == "") {
            $("#errValid-RelevantExperience").text("Relevant Experience field is required");
            isValid = false;
        }        

        var attachmentFilePath = $("#FilePath").val();
        if ($("#existFilePath").val() == "" && attachmentFilePath == "") {
            $("#errValid-AttachmentFilePath").text("Attachment field is required");
            isValid = false;
        }

        if (attachmentFilePath != "") {
            var ext = attachmentFilePath.split('.').pop();
            if (ext == "pdf" || ext == "doc" || ext == "jpeg" || ext == "png" || ext == "jpg" || ext == "jfif" || ext == "bmp") {

            } else {
                $("#errValid-Document").show();
                isValid = false;
            }
        }

        var attachmentLength = $('#FilePath').prop("files").length;
        if (attachmentLength > 0) {
            if ($('#FilePath').prop("files")[0].size > 2000000) {
                $("#errValid-ErrorFileSize").text('Allowed file size exceeded. (Max. 2 MB)!');
                $(".docWebsiteFile").hide();
                return false;
            }
            else {
                formData.append("file", $('#FilePath').prop("files")[0]);
            }
        }

        var isRecordForm = $("#IsRecordForm").val();
        if (isRecordForm == "") {
            var strFmtSkill = $("#strFmtSkill").val();
            formData.append("SkillNames", strFmtSkill);
        }
        else {
            var skills = $("#SkillId option:selected").text();
            if (skills == "") {
                $("#errValid-Skills").text("Skills field is required");
                isValid = false;
            }
            else {
                var selected = $('#SkillId').find(':selected').length;
                for (var i = 0; i < selected; i++) {
                    var sel = $('#SkillId').find(':selected')[i].innerText;
                    formData.append("SkillNames", sel);
                }
            }
        }

        var jobApplyId = $("#JobApplyId").val();
        var jobId = $("#JobName").val();
        var name = $("#FullName").val();
        var email = $("#Email").val();
        var experience = $("#Experience").val();
        var relevantExp = $('#RelevantExperience').val();
        var isActive = $("#IsActive").val();
        var attachment = $("#Attachment").val();
        var applyDate = $("#ApplyDate").val();
        var oldFile = $("#existFilePath").val();

        formData.append("JobId", jobId);
        formData.append("JobApplyId", jobApplyId);
        formData.append("FullName", name);
        formData.append("Email", email);
        formData.append("Experience", experience);
        formData.append("RelevantExperience", relevantExp);
        formData.append("IsActive", isActive);
        formData.append("Attachment", attachment);
        formData.append("ApplyDate", applyDate);
        formData.append("IsRecordForm", isRecordForm);
        formData.append("FilePath", oldFile);

        if (isValid) {
            var url = "/WebsiteJob/UpdateWebsiteAppliedJob";
            var isEmailVerify = emailCheck(email);
            if (isEmailVerify) {
                $.ajax({
                    type: "POST",
                    url: url,
                    data: formData,
                    contentType: false,
                    processData: false,
                    beforeSend: function () {
                        $('.loader').removeClass('d-none');
                    },
                    success: function (result) {
                        $("#success_CreateWebsiteJob_Popup").css('display', 'none !important');
                        swal.fire({
                            title: "Updated Successfully",
                            text: "",
                            icon: "success",
                            allowOutsideClick: false
                        }).then((resultValue) => {
                            if (resultValue.isConfirmed > 0) {
                                var urlToRedirect = '@Url.Action("WebsiteJobApply", "WebsiteJob")';
                                window.location.href = urlToRedirect;
                            };
                        });
                    },
                    complete: function () {
                        $('.loader').addClass('d-none');
                    }
                });
            }
            else {
                $('.loader').addClass('d-none');
                $("#errVerifyEmailFormat-OfficeEmail").show();
                return false;
            }
        }
        else {

            return false;
        }
        $("#errValid-Document").hide();
    });
    //------------------------------------------------------------------------------------------------------------------------------------
    // Email Validation
    function emailCheck(email) {
        var isEmailValid = true;
        var mailformat = /^([\w-\.]+)@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;

        $("#errMsgEmailFormat-Email").text("");
        if (!mailformat.test(email)) {
            $("#errVerifyEmailFormat-OfficeEmail").show();
            $("#errMsgEmailFormat-Email").text("Email is invalid");
            isEmailValid = false;
        }
        return isEmailValid
    }
    //------------------------------------------------------------------------------------------------------------------------------------
</script>
