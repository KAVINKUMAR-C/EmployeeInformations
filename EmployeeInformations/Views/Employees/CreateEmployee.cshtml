@using EmployeeInformations.Model.EmployeesViewModel;
@using EmployeeInformations.Common.Enums;
@model Employees
@{
    ViewBag.Title = "CreateEmployee";
    Layout = "_Layout";
}
<div class="nk-block-head nk-block-head-sm">
    <div class="nk-block-between">
        <div class="nk-block-head-content">
            <h3 class="nk-block-title page-title">Create Employee</h3>
        </div><!-- .nk-block-head-content -->
    </div><!-- .nk-block-between -->
</div>
<div class="card card-bordered card-preview">
    <div class="card-inner leave-datatable">
        <form autocomplete="off">
            @Html.AntiForgeryToken()
            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
            <div class="row">
                @Html.HiddenFor(m => m.CompanyId)
                <div class="col-lg-3 col-md-6">
                    <div class="form-group">
                        <label class="form-label">Employee ID</label>
                        @Html.TextBoxFor(m => m.UserName, new { @class = "form-control", @disabled = true })
                        @Html.ValidationMessageFor(m => m.UserName, "", new { @class = "error text-danger" })
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="form-group">
                        <label class="form-label">First Name<span class="required" style="color: #FF0000">*</span></label>
                        @Html.TextBoxFor(m => m.FirstName, new { onkeydown = "return /[a-z]/i.test(event.key)", @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.FirstName, "", new { @class = "error text-danger", id = "errValid-FirstName" })
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="form-group">
                        <label class="form-label">Last Name<span class="required" style="color: #FF0000">*</span></label>
                        @Html.TextBoxFor(m => m.LastName, new { onkeydown = "return /[a-z]/i.test(event.key)", @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.LastName, "", new { @class = "error text-danger", id = "errValid-LastName" })
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="form-group">
                        <label class="form-label">Office Email<span class="required" style="color: #FF0000">*</span></label>
                        @Html.TextBoxFor(m => m.OfficeEmail, new { @class = "form-control", @type = "email" })
                        @Html.ValidationMessageFor(m => m.OfficeEmail, "", new { @class = "error text-danger", id = "errValid-OfficeEmail" })
                        <span id="errVerify-EmailExist" style="display:none;" class="error text-danger"> Office Email already exists! </span>
                        <span id="errVerifyEmailFormat-OfficeEmail" style="display:none;" class="error text-danger">Office Email is invalid </span>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="form-group">
                        <label class="form-label">Role Name<span class="required" style="color: #FF0000">*</span></label>
                        <div>
                            @Html.DropDownListFor(m => m.RoleId, new SelectList(Model.RolesTables, "RoleId", "RoleName"), "--Select Role Name--", new { @class = "form-control", id = "RoleId" })
                        </div>
                        @Html.ValidationMessageFor(m => m.RoleId, "", new { @class = "error text-danger", id = "errValid-RoleId" })
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="form-group">
                        <label class="form-label">Designation<span class="required" style="color: #FF0000">*</span></label>
                        <div>
                            @Html.DropDownListFor(m => m.DesignationId, new SelectList(Model.Designations, "DesignationId", "DesignationName"), "--Select Designation--", new { @class = "form-control", id = "DesignationId" })
                        </div>
                        @Html.ValidationMessageFor(m => m.DesignationId, "", new { @class = "error text-danger", id = "errValid-Designation" })
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="form-group">
                        <label class="form-label">Department<span class="required" style="color: #FF0000">*</span></label>
                        <div>
                            @Html.DropDownListFor(m => m.DepartmentId, new SelectList(Model.Departments, "DepartmentId", "DepartmentName"), "--Select Department--", new { @class = "form-control", id = "DepartmentId" })
                        </div>
                        @Html.ValidationMessageFor(m => m.DepartmentId, "", new { @class = "error text-danger", id = "errValid-Department" })
                    </div>
                </div>

                <div class="col-lg-3  col-md-6 autocomplete">
                    <div class="form-group emp-hol-yr">
                        <label class="form-label">Reporting Person<span class="required" style="color: #FF0000">*</span></label>
                        <div class="selectbox">
                            @Html.DropDownListFor(m => m.ReportingPerson, new SelectList(Model.reportingPeople, "EmpId", "EmployeeName"), new { @class = "form-control", id = "Reporter", multiple = true })
                        </div>
                        @Html.ValidationMessageFor(m => m.ReportingPerson, "", new { @class = "error text-danger", id = "errValid-ReportingPerson" })
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="form-group">
                        <label class="form-label">Essl Id@*<span class="required" style="color: #FF0000">*</span>*@</label>
                        @Html.TextBoxFor(m => m.EsslId, new { @class = "form-control", @type = "number" })
                        @Html.ValidationMessageFor(m => m.EsslId, "", new { @class = "error text-danger", id = "errValid-EsslId" })
                    </div>
                </div>

            </div>


            <div class="col-lg-12 d-flex mt-3 p-0">
                <input type="button" class="btn btn-secondary ml-auto mr-3" id="btnBack" value="Back" />
                <input type="button" class="btn btn-primary" id="btnCreateEmployee" value="Create" />
            </div>

        </form>
    </div>
</div>


<div class="modal" id="success_CreateEmployee_Popup" style="display:none;">
    <div class="modal-dialog">
        <div class="modal-content p-3 text-center">

            <!-- Modal body -->
            <div class="modal-body" id="txtSuccessMeg">
                <h4 class="nk-modal-title"> Employee Created Successfully!</h4>
            </div>

            <!-- Modal footer -->
            <div class="text-center" id="btnCloseCreateEmployee">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>


<script type="text/javascript">

    $(document).ready(function () {

        $("#Reporter").select2();
        $("#Reporter").select2().on("change", function () {

            $("#errValid-ReportingPerson").text("")
        });
        //-----------------------------------------------------------------------------------------------------------------------------------------------------

        // nice scroll Reporter,Designation,Role,Department

        $("#Reporter,#DesignationId,#RoleId,#DepartmentId").select2().on("select2:open", function () {
            $('.select2-results__options').niceScroll({
                cursorcolor: "#4e5e7a",
                cursorwidth: "5px",
                autohidemode: false,
                cursorborder: "1px solid #4e5e7a",
                horizrailenabled: false,
            });
        });

        $('#btnBack').click(function () {
            var urlToRedirect = '@Url.Action("EmployeesInfo", "Employees")';
            window.location.href = urlToRedirect;
        });

        var select = "Please Select";

        $("#Reporter").change(function () {
            $("#errValid-ReportingPerson").text("")

            if ($("#Reporter option:selected").text() == '') {
                $("#errValid-ReportingPerson").text("Reporting Person field is required");
            }
            else {
                $("#errValid-ReportingPerson").text("")
            }

        });

    });

    // KeyUp Summary

    $("#FirstName").keyup(function () {
        $("#errValid-FirstName").text("");

        if ($("#FirstName").val() == "") {
            $("#errValid-FirstName").text("First Name field is required");
        }
    });

    $("#LastName").keyup(function () {
        $("#errValid-LastName").text("");

        if ($("#LastName").val() == "") {
            $("#errValid-LastName").text("Last Name field is required");
        }
    });

    $("#OfficeEmail").keyup(function () {
        $("#errValid-OfficeEmail").text("");
        $("#errVerifyEmailFormat-OfficeEmail").hide();
        $("#errVerify-EmailExist").hide();

        if ($("#OfficeEmail").val() == "") {
            $("#errValid-OfficeEmail").text("Office Email field is required");
        }
    });

    // Change Summary

    $("#DesignationId").change(function () {
        $("#errValid-Designation").text("");

        if ($("#DesignationId").val() == "") {
            $("#errValid-Designation").text("Designation field is required");
        }
        else {
            $("#errValid-Designation").text("");
        }

    });

    $("#DepartmentId").change(function () {
        $("#errValid-Department").text("");
        if ($("#DepartmentId").val() == "") {
            $("#errValid-Department").text("Department field is required");
        }
        else {
            $("#errValid-Department").text("");
        }
    });

    $("#RoleId").change(function () {
        var isValid = true;
        $("#errValid-RoleId").text("");
        if ($("#RoleId").val() == "") {
            $("#errValid-RoleId").text("Role Name field is required");
            isValid = false;
        }
    });

    //$("#EsslId").keyup(function() {
    //    $("#errValid-EsslId").text("");

    //    if ($("#EsslId").val() == "") {
    //        $("#errValid-EsslId").text("EsslId field is required");
    //    }
    //});
    //-----------------------------------------------------------------------------------------------------------------------------------------------------

    // Create Employee

    $("#btnCreateEmployee").click(function () {

        var formData = new FormData();

        var isValid = true;
        $("#errValid-FirstName").text("");
        $("#errValid-LastName").text("");
        $("#errValid-OfficeEmail").text("");
        $("#errValid-RoleId").text("");
        $("#errValid-Designation").text("");
        $("#errValid-ReportingPerson").text("");
        $("#errValid-Department").text("");
        $("#errValid-EsslId").text("");

        var isValid = true;
        $("#errValid-officeemail").text("");
        $("#errVerifyEmailFormat-OfficeEmail").hide();
        $("#errVerify-EmailExist").hide();


        if ($("#FirstName").val() == "") {
            $("#errValid-FirstName").text("First Name field is required");
            isValid = false;
        }

        if ($("#LastName").val() == "") {
            $("#errValid-LastName").text("Last Name field is required");
            isValid = false;
        }

        if ($("#OfficeEmail").val() == "") {
            $("#errValid-OfficeEmail").text("Office Email field is required");
            isValid = false;
        }

        if ($("#RoleId").val() == "") {
            $("#errValid-RoleId").text("Role Name field is required");
            isValid = false;
        }

        if ($("#DesignationId").val() == "") {
            $("#errValid-Designation").text("Designation field is required");
            isValid = false;
        }

        if ($("#Reporter option:selected").text() == '') {
            $("#errValid-ReportingPerson").text("Reporting Person field is required");
            isValid = false;
        }

        if ($("#DepartmentId").val() == "") {
            $("#errValid-Department").text("Department field is required");
            isValid = false;
        }

        //if ($("#EsslId").val() == "") {
        //    $("#errValid-EsslId").text("EsslId field is required");
        //    isValid = false;
        //}


        var userName = $("#UserName").val();
        var firstName = $("#FirstName").val();
        var lastName = $("#LastName").val();
        var officeEmail = $("#OfficeEmail").val();
        var roleId = $('#RoleId').val();
        var designationId = $("#DesignationId").val();
        var reporters = $("#Reporter").val();
        var departmentId = $("#DepartmentId").val();
        var esslId = $("#EsslId").val();
        var employees = {
            UserName: userName,
            FirstName: firstName,
            LastName: lastName,
            OfficeEmail: officeEmail,
            RoleId: roleId,
            DesignationId: designationId,
            ReportingPersonEmpId: reporters,
            DepartmentId: departmentId,
            esslId: esslId
        };

        formData.append("OfficeEmail", officeEmail);

        if (isValid) {
            var isEmailVerify = emailCheck(officeEmail);
            if (isEmailVerify) {
                $.ajax({
                    type: "POST",
                    url: "/Employees/GetEmailCount",
                    contentType: false,
                    processData: false,
                    data: formData,
                    beforeSend: function () {
                        $('.loader').removeClass('d-none');
                    },
                    success: function (result) {

                        if (result == 0) {
                            var url = "/Employees/CreateEmployee";
                            $.ajax({
                                type: "POST",
                                url: url,
                                data: employees,
                                beforeSend: function () {
                                    $('.loader').removeClass('d-none');
                                },
                                success: function (Result) {
                                    if (Result > 0) {
                                        // $("#success_CreateEmployee_Popup").modal('show');
                                        // $("#btnCloseCreateEmployee").click(function() {
                                        Swal.fire({
                                            title: 'Employee Created Successfully!',
                                            text: "",
                                            icon: 'Success',
                                            allowOutsideClick: false
                                        }).then((resultValue) => {
                                            var urlToRedirect = '@Url.Action("EmployeesInfo", "Employees")';
                                            window.location.href = urlToRedirect;
                                        });
                                    }
                                    else {
                                        Swal.fire({
                                            title: 'Something error',
                                            text: "",
                                            icon: 'error',
                                            allowOutsideClick: false
                                        }).then((resultValue) => {
                                            var urlToRedirect = '@Url.Action("EmployeesInfo", "Employees")';
                                            window.location.href = urlToRedirect;
                                        });
                                    }
                                },
                                complete: function () {
                                    $('.loader').addClass('d-none');
                                }
                            });
                        }
                        else {
                            $('.loader').addClass('d-none');
                            $("#errVerify-EmailExist").show();
                            return false;
                        }
                    },
                    complete: function () {
                        // $('.loader').addClass('d-none');
                    }
                })
            }
            else {
                $('.loader').addClass('d-none');
                $("#errVerifyEmailFormat-OfficeEmail").show();
                return false;
            }

        }
        else {

            return false;
        }

    });

    // Email Validation
    function emailCheck(officeEmail) {
        var isEmailValid = true;
        var mailformat = /^([\w-\.]+)@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
        $("#errVerifyEmailFormat-OfficeEmail").hide();
        if (!mailformat.test(officeEmail)) {
            $("#errVerifyEmailFormat-OfficeEmail").show();
            isEmailValid = false;
        }
        return isEmailValid
    }

</script>
