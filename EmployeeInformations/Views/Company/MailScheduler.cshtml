@using EmployeeInformations.Common
@using EmployeeInformations.Common.Enums;
@using EmployeeInformations.Model.CompanyViewModel;
@model MailSchedulerViewModels 
@{
    ViewBag.Title = "MailScheduler";
    Layout = "_Layout";
}

<div class="nk-block-head nk-block-head-sm">
    <div class="nk-block-between">
        <div class="nk-block-head-content">
            <h3 class="nk-block-title page-title">Mail Scheduler</h3>
        </div><!-- .nk-block-head-content -->
        <div class="d-flex mb-1">
            @Html.ActionLink("Create","CreateMailScheduler","Company", null, new { @class = "btn btn-primary ml-auto mt-auto mb-auto btn-sm" })
        </div>
    </div><!-- .nk-block-between -->
</div>

<div class="card card-bordered card-preview">
    <div class="card-inner table-card">
        <table class="display employee-holiday-table mb-3 no-sorting" style="width:100%" data-auto-responsive="false" id="getmailScheduler">           
            <thead>
                <tr class="nk-tb-item table-header">
                    <th class="nk-tb-col tb-col" data-id="ReportName"><span class="sub-text">Name</span></th>
                    <th class="nk-tb-col tb-col" data-id="DurationId"><span class="sub-text">Duration</span></th>
                    <th class="nk-tb-col tb-col" data-id="MailTime" style="display:none;"><span class="sub-text">Mail Date Time</span></th>
                    <th class="nk-tb-col tb-col" data-id="MailTime"><span class="sub-text">Mail Date</span></th>
                    <th class="nk-tb-col tb-col" data-id="MailTime"><span class="sub-text">Mail Time</span></th>
                    <th class="nk-tb-col tb-col" data-id="FileFormat"><span class="sub-text">File Attachment</span></th>
                    <th class="nk-tb-col tb-col" data-id="IsActive"><span class="sub-text">Status</span></th>
                    <th class="nk-tb-col tb-col" ><span class="sub-text">Action</span></th>
                </tr>
            </thead>
          
       </table>
    </div>
</div>

<div class="modal" id="success_Designation_Popup" style="display:none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mail Schedule Detail</h5>
            </div>
            <!-- Modal body -->
            <div class="modal-body" id="txtSuccessMeg">
                <div>
                    <div class="col-12">
                        <label class="form-label">Name</label>
                        <div class="form-group">
                            <lable class="badge badge-sm bg-outline-primary" id="Designation"> </lable>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="form-group">
                        <div class="custom-control custom-control-sm custom-checkbox">
                            <input type="checkbox" name="chkIsActive" class="custom-control-input chkIsActiveStatus" id="chkIsActiveStatus">
                            <label class="custom-control-label" for="chkIsActiveStatus">Status</label>
                        </div>                        
                    </div>
                </div>

                <div class="col-lg-12 d-flex mt-3 p-0">
                    <input type="button" class="btn btn-primary ml-auto mr-3" id="btnChangeSataus" value="Save" />
                    <input type="button" class="btn btn-danger" id="btnClosePopUp" value="Cancel"/>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {

        var columnIndex = "";
        var columnDirection = "";
        var entries = 10;

        BindMailSchedulerData();
        function BindMailSchedulerData() {
            var table = $("#getmailScheduler").DataTable();

            if (table) {
                table.destroy();
            }
            var count = 0;
            $('#getmailScheduler').DataTable({

                serverSide: true,
                processing: true,
                pageLength: entries,
                ajax: {
                    url: "/Company/GetCompanyMailScheduler",
                    type: 'Get',
                    data: function (d) {
                        var searchFilter = document.getElementById("getmailScheduler_filter"); // get search div id
                        var searchInput = searchFilter.querySelector("input[type='search']");  // get search div input
                        var searchValue = searchInput.value;  // get search value
                        var mailEntry = document.getElementById("getmailScheduler_length"); //get entries div id
                        var entrySelect = mailEntry.querySelector("select"); //get entries div select
                        entries = entrySelect.value; // get entries value
                        d.sSearch = searchValue; // Pass search query
                        d.iDisplayStart = d.iDisplayStart || 0;
                        d.iDisplayLength = d.iDisplayLength || entries;
                        d.sEcho = d.start;
                        d.ColumnName = columnIndex;
                        d.ColumnDirection = columnDirection;

                    }
                },
                columns: [

                    {
                        data: 'reportName',
                        render: function (data, type, row, meta) {
                            return "<tr class='nk - tb - item'><td class='nk-tb-col tb-col'><span class='tb-lead text-primary'>" + row.reportName + "</td></tr>";
                        }
                    },


                    {
                        data: 'durationId',
                        render: function (data, type, row, meta) {
                            return "<tr class='nk - tb - item'><td class='nk - tb - col tb - col'>" + row.durations + " </td></tr>";

                        }
                    },


                    {
                        data: 'mailTime',
                        render: function (data, type, row, meta) {
                            return "<td class='nk - tb - col tb - col'> <style='display: none;'>" + dateFormat(row.mailTime) + "</style></td>";
                        }
                    },
                    {
                        data: 'mailTime',
                        render: function (data, type, row, meta) {
                            return "<td class='nk - tb - col tb - col'> <style='display: none;'>" + timeFormat(row.mailTime) + "</style></td>";
                        }
                    },

                    {
                        data: 'fileFormat',
                        render: function (data, type, row, meta) {
                            if (row.fileFormat == 1) {
                                return "<td class='nk-tb-col tb-col'><b class='badge badge-dot bg-success'>Attached</b></td>";
                            } else if (row.fileFormat == 2) {
                                return "<td class='nk-tb-col tb-col'><b class='badge badge-dot bg-success'>Attached</b></td>";
                            }
                            else if (row.fileFormat == 3) {
                                return "<td class='nk-tb-col tb-col'><b class='badge badge-dot bg-success'>Attached</b></td>";
                            }
                            else {
                                return "<td class='nk-tb-col tb-col'><b class='badge badge-dot bg-danger'> In Attached</b></td>";
                            }
                        }
                    },

                    {
                        data: 'isActive',
                        render: function (data, type, row, meta) {
                            if (row.isActive == true) {
                                return "<td class='nk-tb-col tb-col'><b class='badge badge-dot bg-success'> Active </b></td>";

                            }
                            else {
                                return "<td class='nk-tb-col tb-col'><b class='badge badge-dot bg-danger'> In Active </b></td>";

                            }

                        }
                    },
                    {
                        data: 'null',
                        "orderable": false,
                        render: function (data, type, row) {
                           
                            return "<td class='nk-tb-col tb-col'><div class='nk-tb-col nk-tb-col-tools py-0 border-0'><ul class='k-tb-actions gx-1 my-n1'><li class='me-n1'><div class='dropdown'><a href='#' class='dropdown-toggle btn btn-icon btn-trigger' data-bs-toggle='dropdown'><em class='icon ni ni-more-h'></em></a><div class='dropdown-menu dropdown-menu-end'><ul class='link-list-opt no-bdr'><li><a href='javascript:void(0)' class='btnUpdate' data-id='" + row.schedulerId + "'><em class='icon ni ni-edit'></em><span>Edit</span></a></li><li><a href='javascript:void(0)' id='btnDelete' data-id='" + row.schedulerId + "'><em class='icon ni ni-delete'></em><span>Delete</span></a></li></ul></div></div></li></ul></div></td>";
                        }
                    },

                ],

                "createdRow": function (row, data, dataIndex, settings) {
                    // Add custom class to the row
                    $(row).addClass('nk-tb-item');
                    // Add custom classes to each cell in the row if necessary
                    $(row).find('td').addClass('nk-tb-col tb-col');
                }
            });
        }

        //sorting
        $(document).on('click', '.sorting, .sorting_asc, .sorting_desc', function (e) {
            var target = e.target;
            var parent = target.parentNode;
            var index = [].indexOf.call(parent.children, target);

            if ($(this).hasClass('sorting_asc')) {
                columnDirection = 'desc';
            }
            else {
                columnDirection = 'asc'; // Assuming default sorting direction is descending
            }

            columnIndex = $(this).data('id');
        });
    });
    

    

    $('#btnBack').click(function () {
        var urlToRedirect = '@Url.Action("MailScheduler","Company")';
        window.location.href = urlToRedirect;
    });

    $('#getmailScheduler').on('click', '.btnUpdate', function () {
        var schedulerId = $(this).data('id');       
        PageUtil.goToContent("/Company/EditScheduler?schedulerId=" + schedulerId);
    });

    

    $(document).ready(function () {
        $("#btnChangeSataus").click(function () {
            $("#Create_Popup").modal('show');
        });
    });

    $("#btnCloseDesignation").click(function () {
        $("#Create_Popup").hide();
        var urlToRedirect = '@Url.Action("MailScheduler","Company")';
        window.location.href = urlToRedirect;
    });  
    //--------------------------------------------------------------------------------------------------------------------------------------------------

    // Delete 

    $('#getmailScheduler').on('click', '#btnDelete', function () {
        Swal.fire({
            title: 'Are you sure want to delete?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#1ee0ac',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes',
            cancelButtonText: 'No',
            allowOutsideClick: false
        }).then((result) => {
            if (result.isConfirmed) {
                var schedulerId = $(this).data("id")
               
                $.ajax({
                    type: "POST",
                    url: "/Company/DeletedMailSchedule?schedulerId=" + schedulerId,
                    beforeSend: function () {
                        $('.loader').removeClass('d-none');
                    },
                    success: (Result) => {
                        
                        if (Result == true) {
                            $('#displayEmail').html('');

                            Swal.fire({
                                title: 'Deleted Successfully!',
                                text: "",
                                icon: 'success',
                                allowOutsideClick: false
                            }).then((result) => {
                                window.location.href = "/Company/MailScheduler";
                            });
                        }
                        else {
                            Swal.fire({
                                title: 'Something error',
                                text: "",
                                icon: 'error',
                                allowOutsideClick: false
                            }).then((result) => {
                                window.location.href = "/Company/MailScheduler";
                            });
                        }
                    },
                    complete: function () {
                        $('.loader').addClass('d-none');
                    }
                });

                $("#EmailId").val('');
                $("#displayName").val('');

            }
        })
    });
    //-----------------------------------------------------------------------------------------------------------------------------------------------------------

    $("#btnClosePopUp").click(function () {
        $("#success_Designation_Popup").hide();
        var urlToRedirect = '@Url.Action("MailScheduler","Company")';
        window.location.href = urlToRedirect;
    });
    $(document).ready(function () {
        $('#success_Designation_Popup').modal({
            backdrop: 'static',
            keyboard: false
        })
    });

    //dateformat
    function dateFormat(mailDate) {
     
        var dateObject = new Date(mailDate);
        var day = ("0" + dateObject.getDate()).slice(-2);
        var month = ("0" + (dateObject.getMonth() + 1)).slice(-2);
        var year = dateObject.getFullYear();
        var formattedDate = day + "/" + month + "/" + year;
        return formattedDate;
    }
    //TimeFormat
    function timeFormat(mailTime) {
    
        var dateObject = new Date(mailTime);
            var hours = dateObject.getHours();
            var minutes = dateObject.getMinutes();
            var seconds = dateObject.getSeconds();
            var ampm = hours >= 12 ? 'PM' : 'AM';

            // Convert hours from 24-hour to 12-hour format
            if (hours > 12) {
                hours = hours - 12;
            } else if (hours === 0) {
                hours = 12;
            }

            // Add leading zeros to minutes and seconds
            minutes = ("0" + minutes).slice(-2);
            seconds = ("0" + seconds).slice(-2);

            var formattedDate =  hours + ":" + minutes + ":" + seconds + " " + ampm;
            return formattedDate;

    }

   
    
</script>