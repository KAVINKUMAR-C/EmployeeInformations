@using EmployeeInformations.Model.TeamsViewModel;
@model Teams


<div class="nk-block-head nk-block-head-sm">
    <div class="nk-block-between">
        <div class="nk-block-head-content">
            <h3 class="nk-block-title page-title">Update Teams Meeting</h3>
        </div><!-- .nk-block-head-content -->
    </div><!-- .nk-block-between -->
</div>
<div class="card card-bordered card-preview">
    <div class="card-inner">
        <form autocomplete="off">
            @Html.AntiForgeryToken()
            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
            @Html.HiddenFor(m =>m.TeamsMeetingId)
            @Html.HiddenFor(m =>m.MeetingId)
            @Html.HiddenFor(m => m.Code)
            <div class="row">

                <div class="col-lg-4 col-md-6">
                    <div class="form-group">
                        <label class="form-label">Meeting Name<span class="required" style="color: #FF0000">*</span></label>
                        @Html.TextBoxFor(m => m.MeetingName, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.MeetingName, "", new { @class = "error text-danger", id = "errValid-MeetingName" })
                    </div>
                </div>

                <div class="col-lg-4 col-md-6">
                    <div class="form-group">
                        <label class="form-label">Start Date<span class="required" style="color: #FF0000">*</span></label>
                        <div id="datepicker31" class="input-group date" data-date-format="dd/mm/yyyy">
                            @Html.TextBoxFor(m => m.StartDate, "{0:dd/MM/yyyy}", new { @class = "form-control", @value = Model.StartDate.ToString("dd/mm/yyyy") })
                            <span class="input-group-addon">
                                <i class="icon ti-calendar"></i>
                            </span>
                        </div>

                        @Html.ValidationMessageFor(m => m.StartDate, "", new { @class = "error text-danger", id = "errValid-Startdate" })

                    </div>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label class="form-label">Start Time<span class="required" style="color: #FF0000">*</span></label>
                                <div class="input-group" id="drp_FromTime">
                                    <input type="text" class="form-control StartTime" id="StartTime" placeholder="" value="@Model.MeetingStartTime">                                 
                                </div>
                                <span class="error text-danger" id="errValid-StartTime"></span>
                            </div>
                        </div>

                        <div class="col">
                            <div class="form-group">
                                <label class="form-label">End Time<span class="required" style="color: #FF0000">*</span></label>
                                <div class="input-group" id="drp_ToTime">
                                    <input type="text" class="form-control EndTime" id="EndTime" placeholder="" value="@Model.MeetingEndTime">                                
                                </div>
                                <span class="error text-danger" id="errValid-EndTime"></span>
                                <span id="errVerify-MeetingEndTime" class="error text-danger" style="display:none; "> Please select <b>End Time</b> should not be less than <b>Start Time</b> </span>
                            </div>
                        </div>
                    </div>
                </div>                               
                <div class="col-lg-4 col-md-6">
                    <div class="form-group">
                        <label class="form-label">Emails of attendees separated with ';'<span class="required" style="color: #FF0000">*</span></label>
                        @Html.TextBoxFor(m => m.AttendeeEmail, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.AttendeeEmail, "", new { @class = "error text-danger", id = "errValid-AttendeeEmail" })
                    </div>
                </div>
            </div>


            <div class="col-lg-12 d-flex mt-3 p-0">
                <input type="button" class="btn btn-secondary ml-auto mr-3" id="btnBack" value="Back" />
                <input type="button" class="btn btn-primary" id="btnUpdateTeams" value="Save" />
            </div>

        </form>
    </div>
</div>


<script type="text/javascript">

    $(document).ready(function () {

        var date = new Date();
        $("#datepicker31").datepicker({
            autoclose: true,
            todayHighlight: true,
            startDate: date
        });


        $('#StartTime').timepicker({
            dynamic: false,
            dropdown: true,
            scrollbar: true,
            change: function (time) {
                $("#errValid-StartTime").text("");
                if ($("#StartTime").val() == "") {
                    $("#errValid-StartTime").text("Start Time field is required");
                }
            }
        });

        $('#EndTime').timepicker({
            dynamic: false,
            dropdown: true,
            scrollbar: true,
            change: function (time) {
                $("#errValid-EndTime").text("");
                if ($("#EndTime").val() == "") {
                    $("#errValid-EndTime").text("End Time field is required");
                }
            }
        });

    });


    $("#btnBack").click(function () {
        var urlToRedirect = '@Url.Action("Teams", "Teams")';
        window.location.href = urlToRedirect;
    });



    $("#btnUpdateTeams").click(function () {
        var formData = new FormData();
        var isValid = true;
       
        $("#errValid-MeetingName").text("");
        $("#errValid-AttendeeEmail").text("");
        $("#errValid-StartTime").text("");
        $("#errValid-EndTime").text("");
        $("#errVerify-MeetingEndTime").hide();
        $("#errValid-Startdate").text();

        if ($("#MeetingName").val() == "") {
            $("#errValid-MeetingName").text("Meeting Name field is required");
            isValid = false;
        }

        if ($("#AttendeeEmail").val() == "") {
            $("#errValid-AttendeeEmail").text("AttendeeEmail field is required");
            isValid = false;
        }

        if ($("#EndTime").val() == "") {
            $("#errValid-EndTime").text("End Time field is required");
            isValid = false;
        }

        if ($("#StartTime").val() == "") {
            $("#errValid-StartTime").text("Start Time field is required");
            isValid = false;
        }

        if ($("#StartDate").val() == "") {
            $("#errValid-Startdate").text("Start Date field is required");
            isValid = false;
        }


        var meetingName = $("#MeetingName").val();
        var attendeeEmail = $("#AttendeeEmail").val();
        var begin = $("#StartDate").val();
        var startTime = $("#StartTime").val();
        var endTime = $("#EndTime").val();
        var meetingId = $("#MeetingId").val();
        var teamMeetingId = $("#TeamsMeetingId").val();
        var Code = $("#Code").val();

        formData.append("MeetingName", meetingName);
        formData.append("AttendeeEmail", attendeeEmail);
        formData.append("MeetingStartTime", startTime);
        formData.append("MeetingEndTime", endTime);
        formData.append("StrStartdate", begin);
        formData.append("TeamsMeetingId", teamMeetingId);
        formData.append("MeetingId", meetingId);
        formData.append("Code", Code);

        if (isValid) {
            var isTimeValid = getTimeValid(begin, startTime, endTime);
            var url = "/Teams/UpdateTeamsMeetinges";
            if (isTimeValid) {
                $('.loader').removeClass('d-none');
                $.ajax({
                    type: "POST",
                    url: url,
                    data: formData,
                    contentType: false,
                    processData: false,
                    beforeSend: function () {
                        $('.loader').removeClass('d-none');
                    },
                    success: function (result) {
                        if (result > 0) {
                            Swal.fire({
                                title: 'Updated Successfully',
                                text: "",
                                icon: 'success',
                                allowOutsideClick: false
                            }).then((resultValue) => {
                                var urlToRedirect = '@Url.Action("Teams", "Teams")';
                                window.location.href = urlToRedirect;
                            });
                        }
                        else {
                            Swal.fire({
                                title: 'Something error',
                                text: "",
                                icon: 'error',
                                allowOutsideClick: false
                            }).then((resultValue) => {
                                var urlToRedirect = '@Url.Action("Teams", "Teams")';
                                window.location.href = urlToRedirect;
                            });
                        }
                    },
                    complete: function () {
                        $('.loader').addClass('d-none');
                    }
                });
            } else {
                $('.loader').addClass('d-none');
                $("#errVerify-MeetingEndTime").show();
                return false;
            }
        }
        else {
            return false;
        }
    });

    // Time validation

    function getTimeValid(begin, startTime, endTime) {
        console.log("begin :" + begin);
        var result = false;
        var splitDate = begin.split('/');
        var formatDate = splitDate[2] + "/" + splitDate[1] + "/" + splitDate[0];
        var fromDateTime = new Date(formatDate + ' ' + startTime);
        var toDateTime = new Date(formatDate + ' ' + endTime);

        console.log("fromDateTime :" + fromDateTime);
        console.log("toDateTime :" + toDateTime);
        if (fromDateTime < toDateTime) {
            result = true;
        }
        return result;
    }


 </script>

