@using EmployeeInformations.Model.MasterViewModel;
@using Microsoft.AspNetCore.Http;
@model TicketTypes

<div class="leave-dtl-block">
    <div class="nk-block-head nk-block-head">
        <div class="nk-block-between">
            <div class="nk-block-head-content">
                <h3 class="nk-block-title page-title">Update Ticket Type</h3>
            </div><!-- .nk-block-head-content -->
        </div><!-- .nk-block-between -->
    </div>
    <div class="card card-bordered card-preview">
        <div class="card-inner">
            <form>
                @Html.AntiForgeryToken()
                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                <div class="row">
                    @Html.HiddenFor(m => m.TicketTypeId)
                    <input type="hidden" id="StrFmtReportingPerson" value="@Model.StrFmtReportingPersonId" />
                    <div class="col-lg-3 col-md-6">
                        <div class="form-group">
                            <label class="form-label">Name<span class="required" style="color: #FF0000">*</span></label>
                            @Html.TextBoxFor(m => m.TicketName, new { @class = "form-control", @disabled = true })
                            @Html.ValidationMessageFor(m => m.TicketName, "", new { @class = "error text-danger", id = "errValid-TicketName" })
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="form-group">
                            <label class="form-label">Employee Name<span class="required" style="color: #FF0000">*</span></label>
                            <div class="selectbox">
                                @Html.DropDownListFor(m => m.ReportingPersonId, new SelectList(Model.reportingPeople, "EmpId", "EmployeeName"), "--Select Employee Name--", new { @class = "form-control", @id = "ReportingPerson", @multiple = true })
                            </div>
                            <span class="error text-danger" id="errValid-EmployeeName"></span>
                        </div>
                    </div>       
                    
                    @if (Model.IsActive)
                    {
                        <div class="col-12">
                            <div class="form-group">
                                <div class="custom-control custom-control-sm custom-checkbox">
                                    <input type="checkbox" name="chkIsActiveModule" checked class="custom-control-input chkIsActiveModule" id="chkIsActiveModule">
                                    <label class="custom-control-label" for="chkIsActiveModule">Status</label>
                                </div>
                            </div>
                           
                        </div>
                    }
                    else
                    {
                        <div class="col-12">
                            <div class="form-group">
                                <div class="custom-control custom-control-sm custom-checkbox">
                                    <input type="checkbox" name="chkIsActiveModule" class="custom-control-input chkIsActiveModule" id="chkIsActiveModule">
                                    <label class="custom-control-label" for="chkIsActiveModule">Status</label>
                                </div>
                            </div>
                        </div>
                    }                  
                </div>
               
                <div class="col-lg-12 d-flex mt-3 p-0">
                    <input type="button" class="btn btn-secondary ml-auto mr-3" id="btnTicketBack" value="Back" />
                    <input type="button" class="btn btn-primary" id="btnUpdateTicket" value="Save" />
                </div>

            </form>
        </div>
    </div>
</div>

<script type="text/javascript">


    $("#btnTicketBack").click(function () {
        window.location.href = "/Master/TicketTypes";
    });   

    $(document).ready(function () {

        var empId = $("#ReportingPerson").select2();
        $("#ReportingPerson").select2().on("change", function () {
            $("#errValid-EmployeeName").text("")
        });
       

        var reportingPersonId = $("#StrFmtReportingPerson").val();

        var report = $("#ReportingPerson").select2();

        if (typeof (reportingPersonId) != 'undefined') {
            if (reportingPersonId != null && reportingPersonId != '') {
                var lengthReportingPersonId = reportingPersonId.split(',').length;
                var splitReportingPersonId = reportingPersonId.split(',');

                for (var i = 0; i < lengthReportingPersonId; i++) {
                    $("#ReportingPerson option[value=" + splitReportingPersonId[i] + "]").attr('selected', 'selected').trigger("change");
                }
            }
        }
    });

  
    $("#TicketName").keyup(function () {
        $("#errValid-TicketName").text("");
        if ($("#TicketName").val() == "") {
            $("#errValid-TicketName").text("Ticket Name field is required");
        }
    });

    $("#btnUpdateTicket").click(function () {

        var formData = new FormData();
        var isValid = true;
        $("#errValid-TicketName").text("");        
        $("#errValid-EmployeeName").text("");

        if ($("#TicketName").val() == "") {
            $("#errValid-TicketName").text("Ticket Name field is required");
            isValid = false;
        }

        if ($("#ReportingPerson").val() == "") {
            $("#errValid-EmployeeName").text("Employee Name field is required");
            isValid = false;
        }

       
        var ticketTypeId = $("#TicketTypeId").val();
        var ticketName = $("#TicketName").val();
        var empId = $("#ReportingPerson").val();
        var Active = $("#Active").val();       
        var action = $(".chkIsActiveModule").prop('checked');
        formData.append("IsActive", action);
        formData.append("TicketName", ticketName);
        formData.append("ReportingPersonId", empId);
        formData.append("TicketTypeId", ticketTypeId);

        if (isValid) {

            var url = "/Master/UpdateTicketType";
            $.ajax({
                type: "POST",
                url: url,
                data: formData,
                contentType: false,
                processData: false,
                beforeSend: function () {
                    $('.loader').removeClass('d-none');
                },
                success: function (Result) {
                    $('.loader').addClass('d-none');
                    $("#Create_Popup").css('display', 'none !important');

                    if (Result.ticketTypeId > 0) {
                        swal.fire({
                            title: "Updated Successfully",
                            text: "",
                            icon: "success",
                            allowOutsideClick: false  // This prevents closing on outside click
                        }).then((resultValue) => {
                            if (resultValue.isConfirmed) {
                                window.location.href = "/Master/TicketTypes";
                            };
                        });

                    } else {
                        swal.fire({
                            title: "Something error",
                            text: "",
                            icon: "error",
                            allowOutsideClick: false  // This prevents closing on outside click
                        }).then((resultValue) => {
                            window.location.href = "/Master/TicketTypes";
                        });

                    }
                },
                complete: function () {
                    $('.loader').addClass('d-none');
                }
            });
        }
        else {
            return false;
        }
    });

</script>